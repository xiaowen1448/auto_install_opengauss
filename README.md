# openGauss 自动安装脚本

## ⚠️ 重要警告

**🚨 此脚本仅供测试、学习和交流使用，严禁用于生产环境！**

- **测试环境专用**：此脚本未经过生产环境的充分验证和安全审计
- **学习目的**：适用于学习openGauss数据库的安装和配置过程
- **技术交流**：可用于技术研讨和概念验证
- **生产禁用**：生产环境请使用官方推荐的安装方式和配置

## 脚本概述

这是一个用于自动安装openGauss数据库的Bash脚本，支持多版本选择和多架构自动检测。脚本提供了交互式的版本选择界面，并能够自动下载、配置和安装openGauss数据库。

## 主要功能

### 🔧 核心特性

1. **多版本支持**
   - openGauss 6.0.2(LTS) - 最新长期支持版本 ⭐推荐
   - openGauss 7.0.0-RC1 - 最新候选发布版本
   - openGauss 6.0.0(LTS) - 稳定长期支持版本
   - openGauss 5.0.3(LTS) - 成熟稳定版本
   - openGauss 5.0.2(LTS) - 稳定版本
   - openGauss 5.0.1(LTS) - 稳定版本
   - openGauss 5.0.0(LTS) - 稳定版本

2. **多架构支持**
   - x86_64 (Intel/AMD 64位)
   - AArch64 (ARM 64位)

3. **智能化安装**
   - 自动检测系统架构
   - 动态构建下载链接
   - 智能主机名配置
   - 自动IP地址检测

### 🛠️ 技术特性

#### 版本管理系统
- 内置版本信息映射表
- 动态URL构建机制
- 支持5.x和6.x+版本的不同命名规则
- 自动OM包检测和解压

#### 网络和下载
- 支持wget和curl双重下载工具
- 断点续传功能
- 文件完整性验证
- 下载进度显示

#### 系统配置
- 主机名格式验证
- 自动IP地址获取
- 集群配置文件生成
- 用户和权限管理

#### 自动化安装
- expect脚本自动化交互
- 预安装和数据库安装分离
- 错误处理和状态检查
- 安装后验证

## 系统要求

### 操作系统
- **支持**: openEuler 22.03 / openEuler
- **架构**: x86_64 或 AArch64

### 硬件要求
- **内存**: 建议8GB以上
- **磁盘**: 建议50GB以上可用空间
- **网络**: 需要互联网连接下载安装包

### 软件依赖
脚本会自动安装以下依赖：
- `tar` - 解压工具
- `expect` - 自动化交互工具
- `wget` 或 `curl` - 下载工具

## 使用方法

### 1. 下载脚本
```bash
# 下载脚本到目标服务器
wget https://your-repo/install_opengauss.sh
# 或使用其他方式获取脚本
```

### 2. 设置权限
```bash
chmod +x install_opengauss.sh
```

### 3. 运行脚本
```bash
# 以root用户运行
sudo ./install_opengauss.sh
```

### 4. 交互式选择
脚本运行后会显示：
- 支持的版本列表
- 系统架构信息
- 版本选择菜单

按提示输入数字选择要安装的版本。

## 配置说明

### 默认配置
```bash
DEFAULT_PASSWORD="Admin@2025"  # 默认密码
HOSTNAME=host01                # 默认主机名
```

### 数据库配置
- **端口**: 15400
- **用户**: omm
- **数据库**: postgres
- **安装路径**: /opt/huawei/install/

### 集群配置
脚本会自动生成 `cluster_config.xml` 配置文件，包含：
- 集群名称: dbCluster
- 节点信息: 自动检测的IP和主机名
- 数据路径: /opt/huawei/install/data/dn
- 日志路径: /var/log/omm

## 安装过程

### 自动化步骤
1. **系统检查**: 架构检测、版本验证
2. **下载**: 自动下载对应版本的安装包
3. **解压**: 解压主安装包和OM管理包
4. **配置**: 生成集群配置文件
5. **预安装**: 创建用户、设置权限
6. **安装**: 执行数据库安装
7. **验证**: 检查安装状态

### 预期输出
安装成功后会显示：
- 数据库版本信息
- 连接信息（用户名、密码、端口）
- 常用管理命令
- 注意事项

## 常用命令

安装完成后，使用omm用户执行：

```bash
# 切换到omm用户
su - omm

# 查看数据库状态
gs_om -t status

# 连接数据库
gsql -d postgres -p 15400

# 启动数据库
gs_om -t start

# 停止数据库
gs_om -t stop

# 重启数据库
gs_om -t restart
```

## 技术架构

### 脚本结构
```
install_opengauss.sh
├── 全局变量定义
├── 版本信息映射
├── URL构建函数
├── 系统检测函数
├── 下载管理函数
├── 配置生成函数
├── 安装执行函数
└── 主流程控制
```

### 关键函数
- `detect_architecture()`: 系统架构检测
- `build_download_url()`: 动态URL构建
- `show_version_menu()`: 交互式版本选择
- `download_opengauss()`: 智能下载管理
- `validate_hostname()`: 主机名验证
- `get_local_ip()`: IP地址获取

## 安全注意事项

### ⚠️ 安全风险
1. **硬编码密码**: 脚本中包含默认密码
2. **网络下载**: 从互联网下载安装包
3. **系统修改**: 修改主机名和系统配置
4. **用户创建**: 自动创建系统用户
5. **权限提升**: 需要root权限执行

### 🔒 安全建议
1. **仅测试环境使用**
2. **修改默认密码**
3. **验证下载源**
4. **审查配置文件**
5. **监控安装过程**

## 故障排除

### 常见问题

1. **下载失败**
   - 检查网络连接
   - 验证下载链接
   - 尝试手动下载

2. **权限错误**
   - 确保以root用户运行
   - 检查目录权限
   - 验证用户创建

3. **安装失败**
   - 查看错误日志
   - 检查系统要求
   - 验证配置文件

4. **连接问题**
   - 检查防火墙设置
   - 验证端口配置
   - 确认服务状态

### 日志位置
- 安装日志: `/var/log/omm/`
- 数据库日志: `/opt/huawei/install/data/dn/pg_log/`

## 版本历史

- **当前版本**: 动态版本选择 - 内置URL版本
- **特性**: 支持多版本自动选择和多架构检测

## 许可证

此脚本仅供学习和测试使用，请遵守openGauss的相关许可证条款。

## 免责声明

**重要提醒**：
- 此脚本未经过生产环境验证
- 使用者需自行承担使用风险
- 建议在隔离的测试环境中使用
- 生产环境请使用官方安装指南

---

**📞 技术支持**: 如有问题，请参考openGauss官方文档或社区支持
**🔗 官方网站**: https://opengauss.org/
**📚 官方文档**: https://docs.opengauss.org/